---
- name: Deploy Roughneck
  hosts: roughneck
  become: true

  vars:
    roughneck_user: roughneck
    go_version: "1.23.4"
    # Feature flags for optional components
    enable_gastown: false
    enable_beads: false
    enable_k9s: false
    enable_autocoder: false
    enable_glm: false
    zai_key: ""

  roles:
    # Core system setup
    - common
    - zsh
    - golang
    - git
    - github-cli
    - tmux
    # Container platform
    - docker
    # Development environment
    - code-server
    - caddy
    - direnv
    - mise
    - lazygit
    - lazydocker
    - role: k9s
      when: enable_k9s | default(false) | bool
    # AI coding assistants (installs Node.js)
    - claude
    - codex-cli
    - gemini-cli
    - copilot-cli
    # AutoCoder (requires Node.js from claude role)
    - role: autocoder
      when: enable_autocoder | default(false) | bool
    # GLM/ZAI Claude integration
    - role: glm
      when: enable_glm | default(false) | bool
    - setup-wizard
    # Optional: Gas Town ecosystem (disabled by default)
    - role: beads
      when: enable_beads | default(false) | bool
    - role: roughneck
      when: enable_gastown | default(false) | bool
    - role: systemd
      when: enable_systemd_services | default(false) | bool

  post_tasks:
    # ============================================================================
    # Data Collection - Gather versions and service statuses
    # ============================================================================

    - name: Gather minimal system facts
      setup:
        gather_subset:
          - '!all'
          - 'distribution'
          - 'date_time'

    - name: Get Go version
      command: /usr/local/go/bin/go version
      register: go_version_output
      changed_when: false

    - name: Get Git version
      command: git --version
      register: git_version_output
      changed_when: false

    - name: Get GitHub CLI version
      command: gh --version
      register: gh_version_output
      changed_when: false
      failed_when: false

    - name: Get Zsh version
      command: zsh --version
      register: zsh_version_output
      changed_when: false
      failed_when: false

    - name: Get tmux version
      command: tmux -V
      register: tmux_version_output
      changed_when: false

    - name: Get Node.js version
      command: node --version
      register: node_version_output
      changed_when: false

    - name: Get npm version
      command: npm --version
      register: npm_version_output
      changed_when: false

    - name: Get Docker version
      command: docker --version
      register: docker_version_output
      changed_when: false

    - name: Get Docker Compose version
      command: docker compose version
      register: compose_version_output
      changed_when: false

    - name: Get code-server version
      command: code-server --version
      register: codeserver_version_output
      changed_when: false
      failed_when: false

    - name: Get Claude CLI version
      command: claude --version
      register: claude_version_output
      changed_when: false
      failed_when: false

    - name: Get Codex CLI version
      command: codex --version
      register: codex_version_output
      changed_when: false
      failed_when: false

    - name: Get Gemini CLI version
      command: gemini --version
      register: gemini_version_output
      changed_when: false
      failed_when: false

    - name: Check Copilot CLI installation
      become_user: "{{ roughneck_user }}"
      command: gh extension list
      register: copilot_version_output
      changed_when: false
      failed_when: false

    - name: Get direnv version
      command: direnv --version
      register: direnv_version_output
      changed_when: false
      failed_when: false

    - name: Get mise version
      become_user: "{{ roughneck_user }}"
      command: /home/{{ roughneck_user }}/.local/bin/mise --version
      register: mise_version_output
      changed_when: false
      failed_when: false

    - name: Get lazygit version
      command: lazygit --version
      register: lazygit_version_output
      changed_when: false
      failed_when: false

    - name: Get lazydocker version
      command: lazydocker --version
      register: lazydocker_version_output
      changed_when: false
      failed_when: false

    - name: Get k9s version
      command: k9s version --short
      register: k9s_version_output
      changed_when: false
      failed_when: false
      when: enable_k9s | default(false) | bool

    - name: Check beads installation
      stat:
        path: /home/{{ roughneck_user }}/go/bin/bd
      register: beads_installed
      when: enable_beads | default(false) | bool

    - name: Get Gas Town (gt) version
      become_user: "{{ roughneck_user }}"
      command: /home/{{ roughneck_user }}/go/bin/gt version
      register: gt_version_output
      changed_when: false
      failed_when: false
      when: enable_gastown | default(false) | bool

    - name: Check Docker service status
      command: systemctl is-active docker
      register: docker_service_status
      changed_when: false
      failed_when: false

    - name: Check code-server service status
      command: systemctl is-active code-server
      register: codeserver_service_status
      changed_when: false
      failed_when: false

    - name: Check Caddy service status
      command: systemctl is-active caddy
      register: caddy_service_status
      changed_when: false
      failed_when: false

    - name: Check AutoCoder service status
      command: systemctl is-active autocoder
      register: autocoder_service_status
      changed_when: false
      failed_when: false
      when: enable_autocoder | default(false) | bool

    - name: Read code-server password from server
      slurp:
        src: /home/{{ roughneck_user }}/.config/code-server/password.txt
      register: codeserver_password_file
      failed_when: false

    - name: Set code-server password from file
      set_fact:
        codeserver_password: "{{ codeserver_password_file.content | b64decode | trim }}"
      when: codeserver_password_file.content is defined

    - name: Check Roughneck Mayor service status
      command: systemctl is-active roughneck-mayor
      register: mayor_service_status
      changed_when: false
      failed_when: false
      when: enable_systemd_services | default(false) | bool

    - name: Check Roughneck Deacon service status
      command: systemctl is-active roughneck-deacon
      register: deacon_service_status
      changed_when: false
      failed_when: false
      when: enable_systemd_services | default(false) | bool

    # ============================================================================
    # Verification - Ensure Docker and code-server are working
    # ============================================================================

    - name: Verify Docker is functional
      command: docker ps
      register: docker_verify
      changed_when: false
      failed_when: false

    - name: Verify code-server is accessible
      wait_for:
        port: 10080
        timeout: 5
      failed_when: false

    # ============================================================================
    # Report Generation - Create and display summary
    # ============================================================================

    - name: Generate installation summary report
      template:
        src: installation-summary.txt.j2
        dest: /home/{{ roughneck_user }}/installation-summary.txt
        owner: "{{ roughneck_user }}"
        group: "{{ roughneck_user }}"
        mode: '0644'

    - name: Read generated report for display
      slurp:
        src: /home/{{ roughneck_user }}/installation-summary.txt
      register: summary_report

    - name: Display installation summary
      debug:
        msg: "{{ summary_report['content'] | b64decode }}"

    - name: Fetch installation summary to local deployment directory
      fetch:
        src: /home/{{ roughneck_user }}/installation-summary.txt
        dest: "{{ local_deployment_dir }}/installation-summary.txt"
        flat: true
      when: local_deployment_dir is defined

