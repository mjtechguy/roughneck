---
# =============================================================================
# Caddy Installation Role (TLS reverse proxy)
# =============================================================================
# Installs Caddy web server for automatic HTTPS.
# For DNS-01 mode, builds Caddy with DNS provider plugin using xcaddy.

- name: Set Caddy installation method
  set_fact:
    caddy_needs_dns_plugins: "{{ (tls_mode | default('http01')) == 'dns01' }}"

# =============================================================================
# Standard Caddy (HTTP-01 mode or self-signed) - Use apt package
# =============================================================================

- name: Install Caddy from apt (standard mode)
  when: not caddy_needs_dns_plugins
  block:
    - name: Install required packages for Caddy
      apt:
        name:
          - debian-keyring
          - debian-archive-keyring
          - apt-transport-https
          - curl
        state: present
        update_cache: true

    - name: Add Caddy GPG key
      shell: |
        curl -1sLf 'https://dl.cloudsmith.io/public/caddy/stable/gpg.key' | gpg --dearmor -o /usr/share/keyrings/caddy-stable-archive-keyring.gpg
      args:
        creates: /usr/share/keyrings/caddy-stable-archive-keyring.gpg

    - name: Add Caddy repository
      copy:
        dest: /etc/apt/sources.list.d/caddy-stable.list
        content: |
          deb [signed-by=/usr/share/keyrings/caddy-stable-archive-keyring.gpg] https://dl.cloudsmith.io/public/caddy/stable/deb/debian any-version main
        mode: '0644'
      register: caddy_repo

    - name: Update apt cache after adding Caddy repo
      apt:
        update_cache: true
      when: caddy_repo.changed

    - name: Install Caddy
      apt:
        name: caddy
        state: present

    - name: Ensure Caddy data directory exists with proper permissions
      file:
        path: "{{ item }}"
        state: directory
        owner: caddy
        group: caddy
        mode: '0755'
      loop:
        - /var/lib/caddy/.local
        - /var/lib/caddy/.local/share
        - /var/lib/caddy/.local/share/caddy
        - /var/lib/caddy/.local/share/caddy/pki
        - /var/lib/caddy/.local/share/caddy/pki/authorities
        - /var/lib/caddy/.local/share/caddy/pki/authorities/local

# =============================================================================
# Custom Caddy with DNS plugins (DNS-01 mode) - Use xcaddy
# =============================================================================

- name: Build Caddy with DNS plugins (DNS-01 mode)
  when: caddy_needs_dns_plugins
  block:
    - name: Install build dependencies
      apt:
        name:
          - curl
          - golang-go
        state: present
        update_cache: true

    - name: Install xcaddy
      shell: |
        GOPATH=/root/go go install github.com/caddyserver/xcaddy/cmd/xcaddy@latest
      args:
        creates: /root/go/bin/xcaddy
      environment:
        GOPATH: /root/go

    - name: Set DNS plugin module based on provider
      set_fact:
        caddy_dns_module: >-
          {%- if dns_provider == 'cloudflare' -%}
          github.com/caddy-dns/cloudflare
          {%- elif dns_provider == 'route53' -%}
          github.com/caddy-dns/route53
          {%- elif dns_provider == 'digitalocean' -%}
          github.com/caddy-dns/digitalocean
          {%- elif dns_provider == 'hetzner' -%}
          github.com/caddy-dns/hetzner
          {%- else -%}
          github.com/caddy-dns/cloudflare
          {%- endif -%}

    - name: Check if Caddy is already built with DNS plugin
      stat:
        path: /usr/bin/caddy
      register: caddy_binary

    - name: Build Caddy with DNS plugin
      shell: |
        /root/go/bin/xcaddy build --with {{ caddy_dns_module }} --output /usr/bin/caddy
      environment:
        GOPATH: /root/go
      when: not caddy_binary.stat.exists
      register: xcaddy_build

    - name: Create caddy group
      group:
        name: caddy
        system: true

    - name: Create caddy user
      user:
        name: caddy
        group: caddy
        system: true
        shell: /usr/sbin/nologin
        home: /var/lib/caddy
        create_home: true

    - name: Create Caddy data directories
      file:
        path: "{{ item }}"
        state: directory
        owner: caddy
        group: caddy
        mode: '0755'
      loop:
        - /var/lib/caddy
        - /var/lib/caddy/.local
        - /var/lib/caddy/.local/share
        - /var/lib/caddy/.local/share/caddy
        - /var/lib/caddy/.local/share/caddy/pki
        - /var/lib/caddy/.local/share/caddy/pki/authorities
        - /var/lib/caddy/.local/share/caddy/pki/authorities/local

    - name: Install Caddy systemd service (custom build)
      copy:
        dest: /etc/systemd/system/caddy.service
        content: |
          [Unit]
          Description=Caddy
          Documentation=https://caddyserver.com/docs/
          After=network.target network-online.target
          Requires=network-online.target

          [Service]
          Type=notify
          User=caddy
          Group=caddy
          EnvironmentFile=-/etc/caddy/environment
          ExecStart=/usr/bin/caddy run --environ --config /etc/caddy/Caddyfile
          ExecReload=/usr/bin/caddy reload --config /etc/caddy/Caddyfile --force
          TimeoutStopSec=5s
          LimitNOFILE=1048576
          LimitNPROC=512
          PrivateTmp=true
          ProtectSystem=full
          AmbientCapabilities=CAP_NET_BIND_SERVICE

          [Install]
          WantedBy=multi-user.target
        mode: '0644'
      notify: Reload systemd

    - name: Deploy Caddy environment file (DNS credentials)
      template:
        src: caddy-env.j2
        dest: /etc/caddy/environment
        owner: root
        group: caddy
        mode: '0640'
      notify: Reload Caddy

# =============================================================================
# Common configuration (both modes)
# =============================================================================

- name: Create Caddy config directory
  file:
    path: /etc/caddy
    state: directory
    owner: root
    group: root
    mode: '0755'

# =============================================================================
# Self-signed certificate generation (when not using Let's Encrypt)
# =============================================================================

- name: Generate self-signed certificates for IP-based access
  when: not (enable_letsencrypt | default(false) | bool)
  block:
    - name: Create certs directory
      file:
        path: /etc/caddy/certs
        state: directory
        owner: root
        group: caddy
        mode: '0750'

    - name: Check if certificate exists
      stat:
        path: /etc/caddy/certs/server.crt
      register: cert_file

    - name: Generate self-signed certificate
      when: not cert_file.stat.exists
      shell: |
        openssl req -x509 -newkey rsa:4096 -sha256 -days 3650 \
          -nodes -keyout /etc/caddy/certs/server.key -out /etc/caddy/certs/server.crt \
          -subj "/CN=roughneck" \
          -addext "subjectAltName=IP:{{ ansible_default_ipv4.address }},IP:127.0.0.1,DNS:localhost"
      args:
        creates: /etc/caddy/certs/server.crt

    - name: Set certificate permissions
      file:
        path: "{{ item }}"
        owner: root
        group: caddy
        mode: '0640'
      loop:
        - /etc/caddy/certs/server.crt
        - /etc/caddy/certs/server.key

- name: Deploy Caddyfile
  template:
    src: Caddyfile.j2
    dest: /etc/caddy/Caddyfile
    owner: root
    group: root
    mode: '0644'
  notify: Reload Caddy

- name: Enable and start Caddy service
  systemd:
    name: caddy
    enabled: true
    state: started
    daemon_reload: true

- name: Get Caddy version
  command: caddy version
  register: caddy_version_output
  changed_when: false
  failed_when: false

# Flush handlers to ensure Caddy is restarted if config changed
- name: Flush handlers to restart Caddy
  meta: flush_handlers

# Wait for Caddy to be fully ready
- name: Wait for Caddy to be ready on port 10000
  wait_for:
    port: 10000
    delay: 2
    timeout: 30
  when: not (enable_letsencrypt | default(false) | bool)
