# Caddyfile for Roughneck services
# Generated by Ansible
# TLS Mode: {{ tls_mode | default('http01') }}

{% if enable_letsencrypt | default(false) | bool and domain_name is defined and domain_name != '' %}

{% if tls_mode | default('http01') == 'dns01' %}
# =============================================================================
# DNS-01 MODE - Wildcard certificate via DNS challenge
# =============================================================================

# code-server
code.{{ domain_name }} {
    tls {
{% if dns_provider == 'cloudflare' %}
        dns cloudflare {env.CF_API_TOKEN}
{% elif dns_provider == 'route53' %}
        dns route53 {
            access_key_id {env.AWS_ACCESS_KEY_ID}
            secret_access_key {env.AWS_SECRET_ACCESS_KEY}
        }
{% elif dns_provider == 'digitalocean' %}
        dns digitalocean {env.DO_AUTH_TOKEN}
{% elif dns_provider == 'hetzner' %}
        dns hetzner {env.HETZNER_API_TOKEN}
{% endif %}
    }

    basic_auth {
        roughneck {{ codeserver_password | password_hash('bcrypt') }}
    }

    reverse_proxy localhost:10080

    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
    }
}

{% if enable_autocoder | default(false) | bool %}
# AutoCoder
autocoder.{{ domain_name }} {
    tls {
{% if dns_provider == 'cloudflare' %}
        dns cloudflare {env.CF_API_TOKEN}
{% elif dns_provider == 'route53' %}
        dns route53 {
            access_key_id {env.AWS_ACCESS_KEY_ID}
            secret_access_key {env.AWS_SECRET_ACCESS_KEY}
        }
{% elif dns_provider == 'digitalocean' %}
        dns digitalocean {env.DO_AUTH_TOKEN}
{% elif dns_provider == 'hetzner' %}
        dns hetzner {env.HETZNER_API_TOKEN}
{% endif %}
    }

    basic_auth {
        roughneck {{ codeserver_password | password_hash('bcrypt') }}
    }

    handle /api/* {
        reverse_proxy localhost:51731
    }

    handle {
        reverse_proxy localhost:51730
    }

    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
    }
}
{% endif %}

{% else %}
# =============================================================================
# HTTP-01 MODE - Per-subdomain certificates via HTTP challenge
# =============================================================================

# code-server
code.{{ domain_name }} {
    basic_auth {
        roughneck {{ codeserver_password | password_hash('bcrypt') }}
    }

    reverse_proxy localhost:10080

    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
    }
}

{% if enable_autocoder | default(false) | bool %}
# AutoCoder
autocoder.{{ domain_name }} {
    basic_auth {
        roughneck {{ codeserver_password | password_hash('bcrypt') }}
    }

    handle /api/* {
        reverse_proxy localhost:51731
    }

    handle {
        reverse_proxy localhost:51730
    }

    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
    }
}
{% endif %}

{% endif %}

{% else %}
# =============================================================================
# SELF-SIGNED MODE - IP-based access with internal TLS
# =============================================================================

# code-server
:10000 {
    tls /etc/caddy/certs/server.crt /etc/caddy/certs/server.key

    basic_auth {
        roughneck {{ codeserver_password | password_hash('bcrypt') }}
    }

    reverse_proxy localhost:10080

    header {
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
    }
}

{% if enable_autocoder | default(false) | bool %}
# AutoCoder
:10001 {
    tls /etc/caddy/certs/server.crt /etc/caddy/certs/server.key

    basic_auth {
        roughneck {{ codeserver_password | password_hash('bcrypt') }}
    }

    handle /api/* {
        reverse_proxy localhost:51731
    }

    handle {
        reverse_proxy localhost:51730
    }

    header {
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
    }
}
{% endif %}

{% endif %}
