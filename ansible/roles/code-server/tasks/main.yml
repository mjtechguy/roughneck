---
# =============================================================================
# code-server Installation Role
# =============================================================================
# Installs code-server web-based IDE with password authentication on port 10000
# Generates secure random password and creates systemd service

- name: Download and install code-server
  shell: curl -fsSL https://code-server.dev/install.sh | sh
  args:
    creates: /usr/bin/code-server

- name: Check if password file exists
  stat:
    path: /home/{{ roughneck_user }}/.config/code-server/password.txt
  register: password_file

- name: Read existing password
  slurp:
    src: /home/{{ roughneck_user }}/.config/code-server/password.txt
  register: existing_password
  when: password_file.stat.exists

- name: Use existing password if available
  set_fact:
    codeserver_password: "{{ existing_password.content | b64decode | trim }}"
  when: password_file.stat.exists and existing_password.content is defined

- name: Generate new password for initial deployment
  set_fact:
    codeserver_password: "{{ lookup('password', '/dev/null chars=ascii_letters,digits length=24') }}"
  when: not password_file.stat.exists

- name: Create code-server config directory
  file:
    path: /home/{{ roughneck_user }}/.config/code-server
    state: directory
    owner: "{{ roughneck_user }}"
    group: "{{ roughneck_user }}"
    mode: '0755'

- name: Create code-server data directory
  file:
    path: /home/{{ roughneck_user }}/.local/share/code-server
    state: directory
    owner: "{{ roughneck_user }}"
    group: "{{ roughneck_user }}"
    mode: '0755'

- name: Deploy code-server config file
  template:
    src: config.yaml.j2
    dest: /home/{{ roughneck_user }}/.config/code-server/config.yaml
    owner: "{{ roughneck_user }}"
    group: "{{ roughneck_user }}"
    mode: '0600'
  register: codeserver_config

- name: Store password in file for later retrieval
  copy:
    content: "{{ codeserver_password }}"
    dest: /home/{{ roughneck_user }}/.config/code-server/password.txt
    owner: "{{ roughneck_user }}"
    group: "{{ roughneck_user }}"
    mode: '0600'

- name: Deploy code-server systemd service
  template:
    src: code-server.service.j2
    dest: /etc/systemd/system/code-server.service
    owner: root
    group: root
    mode: '0644'

- name: Reload systemd daemon
  systemd:
    daemon_reload: true

- name: Enable and start code-server service
  systemd:
    name: code-server
    enabled: true
    state: started

- name: Restart code-server if config changed
  systemd:
    name: code-server
    state: restarted
  when: codeserver_config.changed

- name: Wait for code-server to start
  wait_for:
    port: 10080
    delay: 2
    timeout: 30

- name: Display code-server connection info
  debug:
    msg:
      - "=========================================="
      - "code-server Installation Complete"
      - "=========================================="
      - "Internal port: 10080 (Caddy proxies to external)"
      - "External URL: https://<server-ip>:10000"
      - "Password: {{ codeserver_password }}"
      - "=========================================="
